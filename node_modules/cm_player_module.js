// Exports club manager player module

// Dependencies
var async = require('async');

module.exports = function cmPlayerModule() {
  function cmPlayer(){}
  var dbName = 'cm_player';
  
  // Add new custom object type
  // cos = pencilblue custom object service
  // util =  pencilblue utilities
  // cb = callback(error, boolean)
  cmPlayer.install = function(cos, util, cb) {
    cos.loadTypeByName(dbName, function(err, playerType) {
		if(util.isError(err)) {
			return cb(err, false);
		}
		else if(!util.isNullOrUndefined(playerType)){
			return cb(new Error(dbName + ' object already exists.'), false);
		}

        // Custom object fields
		var player = {
			name: dbName,
			fields: {
				name: { field_type: 'text' },
				number: { field_type: 'text' },
				// TODO Media is mandatory, not working yet //profilePicture: { field_type: 'peer_object', object_type: 'media' },
			description: { field_type: 'wysiwyg' }
			}
		};

		cos.saveType(player, function(err, result){
			return cb(err, !util.isError(err));
		});
	});
  };

  // Clear player objects and remove custom object type
  // cos = pencilblue custom object service
  // util = pencilblue utilities
  // cb = callback(err, boolean)
  cmPlayer.uninstall = function(cos, util, cb) {
    cos.loadTypeByName(dbName, function(err, playerType) {
      // If player type does not exist there is nothing to do.
      // Return error if there was any.
      if(util.isNullOrUndefined(playerType) || util.isError(err)) {
        return cb(err, !util.isError(err));
      }
      
      // Clear player objects from database, then
      // delete custom object
      async.series([
        function deleteObjects(cb) {
          cos.deleteForType(playerType, function(err, result) {
              return cb(err);
          });
        },
        function deleteCustomObjectType(cb) {
          cos.deleteTypeById(playerType._id.toString(), function(err) {
            return cb(err);
          });
        }], cb
      );
    });
  };
  
  // Query all player objecst from the database.
  // cos = pencilblue custom object service
  // util = pencilblue utitilities
  // cb = callback(error, data)
  cmPlayer.getPlayers = function(cos, util, cb) {
    // Get player type id and use it to find all player objects,
    // finally call cb
    async.waterfall([
      function getPlayerType(cb){
        cos.loadTypeByName(dbName, function(err, playerType) {
          return cb(err, playerType._id);
        });
      },
      function getPlayerObjects(typeId, cb) {
        var selection = ['name', 'number', 'description'];
        cos.findByType(typeId.toString(), {select: selection}, 
          function(err, result) {
            return cb(err, result);
          }
        );
      }
    ], cb);
  }

  return cmPlayer;
};
